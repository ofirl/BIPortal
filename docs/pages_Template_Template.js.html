<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: pages/Template/Template.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: pages/Template/Template.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { useState } from 'react';
import PropTypes from 'prop-types';
// import { Redirect } from "react-router-dom";
import { connect } from 'react-redux';
import { setActiveFilter, fetchData } from '../../reducers';

import { makeStyles } from '@material-ui/core/styles';

import TopBar from './TopBar/TopBar';
import FilterDrawer from './FilterDrawer/FilterDrawer';

import 'react-grid-layout/css/styles.css';
import 'react-resizable/css/styles.css';

import { Grid, Cell } from "styled-css-grid";
import createChart from './../../components/Chart/Chart';
import { Table } from '../../components/Table/Table';

/**
 * @namespace ReportTemplate
 */

const useStyles = makeStyles(theme => ({
    root: {
        flexGrow: 1,
    },
    mainContainer: {
        position: 'absolute',
        height: '100%'
    },
    mainGrid: {
        transition: '225ms cubic-bezier(0, 0, 0.2, 1) 0ms;',
        backgroundColor: '#fafafa',
    },
    filterOpen: {
        gridTemplateColumns: '0.2fr 1fr',
    },
    content: {
        flexGrow: '1',
    },
    maxWidth100: {
        maxWidth: '100%'
    },
}));

/**
 * Conversion object for filtering &lt;br />
 * Converts a sign to a convertion function
 * 
 * @memberof ReportTemplate
 */
const operatorConv = {
    "=": (val1, val2) => val1 === val2,
    ">=": (val1, val2) => val1 >= val2,
    "&lt;=": (val1, val2) => val1 &lt;= val2,
    ">": (val1, val2) => val1 > val2,
    "&lt;": (val1, val2) => val1 &lt; val2,
    "!=": (val1, val2) => val1 !== val2,
    "date-between": (val1, { startDate, endDate }) => {
        val1 = formatDate(val1);
        return operatorConv[">"](new Date(val1), startDate) &amp;&amp; operatorConv["&lt;"](new Date(val1), endDate);
    },
    "date-single": (val1, val2) => {
        val1 = formatDate(val1);
        return operatorConv["="](new Date(val1).getTime(), val2.getTime());
    },
}

/**
 * Converts the given date to a date object
 * 
 * @param {string} date the date to convert (assuming the date is in dd/MM/yyyy format)
 * 
 * @returns {Date} date object
 * 
 * @memberof ReportTemplate
 */
function formatDate(date) {
    // assuming the date is in dd/MM/yyyy format, if not this will need changing
    let match = /(\d{2})\/(\d{2})\/(\d{4})/.exec(date);
    date = new Date(match[3], match[2] - 1, match[1]);
    return date;
}

/**
 * Filter the data based on the given filter. &lt;br/>
 * Filters the data using the filter object given and the convertion object {@link operatorConv}.
 * 
 * @param {activeFilter} filter 
 * @param {Array.&lt;*>} data the data to filter
 * @returns Filtered data
 * 
 * @memberof ReportTemplate
 */
function filterData(filter, data) {
    let applyFilter = function (dataKey, filterObj, data) {
        // check if the data checks against at least one of the filter values
        return filterObj.some((filterEntry) => operatorConv[filterEntry.operator](data[dataKey], filterEntry.value))
    }

    // check if the data checks against all the filters
    return data.filter((dataVal) => Object.keys(filter).every((filterVal, index, arr) => applyFilter(filterVal, filter[filterVal], dataVal)));
};

/**
 * Changes {@param oldFilters} by the given new filters and key. &lt;br />
 * Adds or deletes the necessary values/keys from the old filters.
 * 
 * @param {string} key filter key
 * @param {activeFilter} newFilters new active filter (only filters relevant to key {@link key})
 * @param {activeFilter} oldFilters old active filter (all keys)
 * 
 * @memberof ReportTemplate
 */
function onFilterChange(key, newFilters, oldFilters) {
    let allFilterObj = { ...oldFilters };

    if (newFilters.length === 0)
        delete (allFilterObj[key]);
    else
        allFilterObj[key] = newFilters;

    return allFilterObj;
}

/**
 * Redirects to the target with the supplied parameters
 * 
 * @param {object} history history object from react-router
 * @param {string} target redirect target
 * @param {object} params additional url parameters
 * 
 * @memberof ReportTemplate
 */
function onRedirect(history, target, params) {
    let paramString = params ? Object.keys(params).map((p) => `${p}=${params[p]}`).join('&amp;') : '';
    history.push(target + "?" + paramString);
}

function Template(props) {
    console.log('render template');
    const classes = useStyles();

    let { children: { layout = {}, content = [], filterDef = {} }, data, history, activeFilters, setActiveFilters, service, fetchDataAction, isFetchingData } = props;
    let { columns: layoutColumns = 'auto-fill', rows: layoutRows = 'auto-fill', /*layoutMinWidth = '600px',*/ layoutMinHeight = '200px' } = layout;
    const [open, setOpen] = useState(false);

    fetchDataAction(service);

    let filteredData = filterData(activeFilters, data);

    if (isFetchingData)
        return (
            &lt;div>
                loading
            &lt;/div>
        );

    return (
        &lt;Grid
            className={[classes.mainGrid, open ? classes.filterOpen : ''].join(' ')}
            height="100%"
            columns={"0fr 1fr"}
            rows={"5em 1fr"}
            areas={[
                "header header",
                "menu   content"
            ]}>
            &lt;Cell area="header">
                &lt;TopBar key="topBar" toggleFilterOpen={() => setOpen(!open)} />
            &lt;/Cell>
            &lt;Cell area="menu">
                &lt;FilterDrawer open={open} data={data} filters={filterDef} activeFilters={activeFilters}
                    onFilterChange={(key, newFilter) => setActiveFilters(onFilterChange(key, newFilter, activeFilters))} />
            &lt;/Cell>
            &lt;Cell area="content" style={{ paddingRight: '10px' }}>
                &lt;Grid
                    columns={layoutColumns}
                    rows={layoutRows}
                    height="100%"
                    minRowHeight={layoutMinHeight}
                >
                    {
                        content ?
                            content.map((c, idx) =>
                                &lt;Template.GridItem key={idx} {...c} data={filteredData} setRedirect={(target, params) => onRedirect(history, target, params)} />)
                            : null
                    }
                &lt;/Grid>
            &lt;/Cell>
        &lt;/Grid>
    );
};
Template.propTypes = {
    /** children to render */
    children: PropTypes.object.isRequired,
    /** history object from react-router */
    history: PropTypes.object.isRequired,
    /** filter definition */
    filterDef: PropTypes.object,
    /** data (from store) */
    data: PropTypes.arrayOf(PropTypes.object),
    /** current active fiters (from store) */
    activeFilters: PropTypes.object,
    /** set activ filters (from store) */
    setActiveFilters: PropTypes.func,
    /** the service to get the data from */
    serviceName: PropTypes.string
};

Template.GridItem = ({ left, top, width, height, render, data, setRedirect, chart, ...others }) => {
    let cellProps = {
        left,
        top,
        width,
        height
    };

    return (
        &lt;Cell {...cellProps}>
            {render ? render(data, setRedirect) : createChart(chart)(data)}
        &lt;/Cell>
    );
};

const mapStateToProps = (state, ownProps) => {
    return {
        data: state.data.fetched,
        isFetchingData: state.data.isFetching,
        activeFilters: state.activeFilter
    }
}

const mapDispatchToProps = (dispatch, ownProps) => {
    return {
        setActiveFilters: (newActiveFilters) => {
            return dispatch(setActiveFilter(newActiveFilters))
        },
        fetchDataAction: (service) => {
            return dispatch(fetchData(service))
        }
    }
}

const ConnectedTemplate = connect(
    mapStateToProps,
    mapDispatchToProps
)(Template)

export default ConnectedTemplate;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="Colors.html">Colors</a></li><li><a href="FilterDrawer.html">FilterDrawer</a></li><li><a href="ReportDefinition.html">ReportDefinition</a></li><li><a href="ReportTemplate.html">ReportTemplate</a></li><li><a href="TreeComponent.html">TreeComponent</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Mon Jul 06 2020 12:37:55 GMT+0300 (Israel Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
